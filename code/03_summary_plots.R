#loading in the necessary libraries -------
library(dplyr)
library(ggplot2)
library(patchwork)
library(ggridges)
library(sf)
library(patchwork)
library(gghalves)
library(ggnewscale)
library(patchwork)
library(rnaturalearth)
library(viridis)
library(tidyverse)
library(tidyr)
library(Hmisc)
library(ggpubr)
library(scales)
library(stars)

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
  latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
  CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

##load data from the overlay analysis - 02_overlay_analysis.R ----
  load("output/bioregion_extract.RData") #extracts of the entire bioregions
  load("output/can_network_extract.RData") #extracts from the Canadian Marine Conservation Network - inside and outside within each bioregion
  load("output/mar_network_extract.RData") #extracts from the Scotian Shelf-Bay of Fundy Draft Network - inside and outside the Maritimes region

#load polygons ----- 
  #using the polygon_load function - this load polygons for each function instead of re-writing the code multiple times. Makes things more consistent. 
  source("code/polygon_load.R")
  polygon_load()
  
  weighted.median <- function(x, w) { #https://stackoverflow.com/questions/2748725/is-there-a-weighted-median-function
    w <- w[order(x)]
    x <- x[order(x)]
    
    prob <- cumsum(w)/sum(w)
    ps <- which(abs(prob - .5) == min(abs(prob - .5)))
    return(x[ps])
  }
  
#Plotting levels ----
      ocean_ord <- c("Pacific","Arctic","Atlantic")
      rcp_ord <- c("RCP 8.5","RCP 2.6")
      
      can_bioregions_centroids <- can_bioregions%>%
        st_centroid()%>%
        st_transform(latlong)%>%
        mutate(lat = st_coordinates(.)[,2],
               ocean = factor(ocean,levels=ocean_ord))%>%
        data.frame()%>%
        arrange(ocean,lat) #arrange them by latitude (centroid) within each bioregion
      
      bioregion_ord <- can_bioregions_centroids%>%pull(region)
      
      mpa_ord <- can_mcn_regions%>%
                           mutate(region=factor(region,levels=bioregion_ord))%>%
                           arrange(region,clat)%>%pull(NAME_E) #arrange them by latitude (centroid) within each bioregion
    
    #Load plotting abbreviations and set levels for the plotting dataframes
      mpa_abbreviations <- read.csv("data/mpa_abbreviations.csv")
      region_abbreviations <- read.csv("data/region_abbreviations.csv")
      mcn_abbreviations <- read.csv("data/mcn_abbreviations.csv") #these are ones that I made up quickly for every type of closure in the Canadian MCN
      mar_abbreviations <- read.csv("data/mar_draft_network_abbreviations.csv")%>%arrange(group,lat) #these are the ones used by Lewis et al. arraged by group and latitute 
      
    #merge in the abbreviations with the extracts and set plotting levels
      bioregion_df <- bioregion_extract%>%
                      left_join(.,region_abbreviations)%>%
                      mutate(region=factor(region,levels=bioregion_ord),
                             rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                             rcp=factor(rcp,levels=rcp_ord)) 
      
      can_mcn_df <- can_mcn_extracts%>%
                    left_join(.,mcn_abbreviations)%>%
                    mutate(name=factor(NAME_E,levels=mpa_ord),
                           region=factor(region,levels=bioregion_ord),
                           ocean=factor(ocean,levels=ocean_ord),
                           rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                           rcp=factor(rcp,levels=rcp_ord))
      
      mar_network_df <- mar_network_extract%>%
                        left_join(.,mar_abbreviations%>%dplyr::select(-c(long,lat)))%>%
                        mutate(name = factor(mar_name,levels = mar_abbreviations%>%pull(abbreviation)),
                               rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                               rcp=factor(rcp,levels=rcp_ord)) 
      
      #dataframe with the area of each bioregion and ocean 
      area_df1 <- can_mcn_df%>%
                 filter(!is.na(vuln),
                        rcp == "RCP 2.6")%>% #don't need to dupliate for the CRP
                 data.frame()%>%
                 dplyr::select(ocean,region,location,cell_area)
      
      area_df <- area_df1%>%
                  group_by(ocean,region,location)%>% #location area ~ bioregion and ocean
                  summarise(location_area = sum(cell_area,na.rm=T))%>%
                  ungroup()%>%
                 left_join(.,area_df1%>% #bioregion area ~ ocean 
                             group_by(region)%>%
                             summarise(region_area = sum(cell_area,na.rm=T))%>%
                             ungroup())%>%
                  left_join(.,area_df1%>% #area ~ ocean 
                              group_by(ocean)%>%
                              summarise(ocean_area = sum(cell_area,na.rm=T))%>%
                              ungroup())
  

## Figure 1 basemap -----
      
      #plot boundaries ---- 
      can_bounding <- can_eez%>%
        st_transform(latlong)%>%
        st_buffer(2)%>% #2 degree buffer on the Canadian EEZ extent
        st_transform(CanProj)%>%
        st_bbox() #bounding box used for plot limits #will give some warnings but it doesn't distort the bounding box by much and it's only a bounding box anyway
      
      can_bounding_polygon <- can_bounding%>%st_as_sfc()%>%st_as_sf()
      
      mar_bound <- mar_region%>%
        st_transform(latlong)%>%
        st_bbox()
      
      #seperate MCN into three types - MPAs, Marine Refuges and all other measurse. 
      can_mcn_formatted <- can_mcn%>%
                           mutate(type=case_when(grepl("Marine Protected",type) ~ "Marine Protected Area",
                                                 grepl("OECM",type) ~ "Marine Refuge",
                                                 TRUE ~ "OECM"))
      
      #load the vulnerability data
      vul_df <- read.csv("data/climate_vulnerability_85.csv") #this is just RCP8.5
      
      #create a raster from the vulnerability data
      test_raster <- vul_df%>%
        data.frame()%>%
        dplyr::select(lon,lat,vuln)%>% #vulnerability from Boyce et al. 2022
        raster::rasterFromXYZ(.,crs=latlong)%>%
        raster::projectRaster(.,crs=CanProj)%>%
        st_as_stars()
      
      #Canadian MCN (Panel A)
      p1 <- ggplot()+
        geom_sf(data=can_eez,fill=NA)+
        geom_sf(data=basemap)+
        geom_sf(data=Canada)+
        geom_sf(data=can_mcn_formatted,aes(fill=type))+
        theme_bw()+
        coord_sf(expand=0,xlim=can_bounding[c(1,3)],ylim=can_bounding[c(2,4)])+
        labs(fill="",x="",y="")+
        scale_fill_manual(values=c("cornflowerblue","coral","grey"))+
        labs(x="") 
      
      #just the bioregions (panel B)
      p2 <- ggplot()+
        geom_sf(data=can_eez,fill=NA)+ #add the base layers
        geom_sf(data=can_bioregions,aes(fill=region))+ #canadian marine bioregions 
        geom_sf(data=basemap)+
        geom_sf(data=Canada)+ #added to show the Can/US border
        theme_bw()+
        coord_sf(expand=0,xlim=can_bounding[c(1,3)],ylim=can_bounding[c(2,4)])+
        labs(fill="",x="",y="")+
        scale_fill_viridis(discrete=T)
      
      #vulnerability raster overlay (Panel C)
      p3 <- ggplot()+
        geom_stars(data=test_raster)+ #add the raster
        scale_fill_viridis_c(na.value="transparent")+
        labs(fill="Vulnerability",x="",y="")+
        geom_sf(data=can_eez,fill=NA)+ #add the base layers
        geom_sf(data=basemap)+
        geom_sf(data=Canada)+ #added to show the Can/US border
        theme_bw()
      
      #maritimes region draft network (panel D)
      p4 <- ggplot()+
        geom_sf(data=basemap%>%st_transform(latlong))+
        geom_sf(data=Canada%>%st_transform(latlong))+
        geom_sf(data=mar_region%>%st_transform(latlong),fill=NA)+
        geom_sf(data=mar_network%>%st_transform(latlong),aes(fill=mar_type))+
        theme_bw()+
        coord_sf(expand=0,xlim=mar_bound[c(1,3)],ylim=mar_bound[c(2,4)])
      
      #stich it together using patchwork
      p5 <- p1 + theme(legend.position="none") + labs(title ="A") +
        p2 + theme(legend.position="none") + labs(title = "B") +
        p3 + theme(legend.position="none") + labs(title = "C") +
        geom_sf(data=mar_bound%>%st_as_sfc()%>%st_transform(CanProj),fill=NA,lwd=0.8) + 
        coord_sf(expand=0,xlim=can_bounding[c(1,3)],ylim=can_bounding[c(2,4)]) + #add the extent of the Maritimes Network
        p4 + theme(legend.position="none") + labs(title = "D")+
        plot_layout(nrow=2)
      
      ggsave("output/Figure1.png",p5,dpi=300,width = 8.98,height=8.98,units="in") #for the readme
      
      
#---------------OCEAN -------------------------------------------------------------------------------------------------------------
 ## Ridge plots ----- ** note that the ridge plots don't currently do weighted ridgelines, but there seem to be some work arounds that maybe you can try (https://github.com/wilkelab/ggridges/issues/5)
  #data.frames that have all the values for the region and then for the site. Note that we can't use the cell_area to weight these values so the plots can be sort of misleading
  atlantic_df <- bioregion_df%>% 
                 filter(!is.na(adcap),ocean=="Atlantic")%>%
                 mutate(location = "Bioregion",
                        NAME_E = NA)%>%
                 dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                 rbind(.,can_mcn_df%>%
                         filter(!is.na(adcap),ocean=="Atlantic",location=="inside")%>%
                         mutate(location = "Conservation Network")%>%
                         dplyr::select(-c(name,Abbreviation,type)))
  
  pacific_df <- bioregion_df%>% 
                filter(!is.na(adcap),ocean=="Pacific")%>%
                mutate(location = "Bioregion",
                       NAME_E = NA)%>%
                dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                rbind(.,can_mcn_df%>%
                        filter(!is.na(adcap),ocean=="Pacific",location=="inside")%>%
                        mutate(location = "Conservation Network")%>%
                        dplyr::select(-c(name,Abbreviation,type)))
  
  arctic_df <- bioregion_df%>% 
                filter(!is.na(adcap),ocean=="Arctic")%>%
                mutate(location = "Bioregion",
                       NAME_E = NA)%>%
                dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                rbind(.,can_mcn_df%>%
                        filter(!is.na(adcap),ocean=="Arctic",location=="inside")%>%
                        mutate(location = "Conservation Network")%>%
                        dplyr::select(-c(name,Abbreviation,type)))
    
#Oceans plots with weighting ---------
  
  atlantic_speed <- ggplot(data=atlantic_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
    geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
    geom_vline(data= atlantic_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network"), aes(xintercept = median(vuln), color = "Conservation Network"))+
    geom_vline(data= atlantic_df%>%filter(rcp=="RCP 2.6", location=="Bioregion"), aes(xintercept = median(vuln), color = "Bioregion"))+
    geom_vline(data= atlantic_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network"), aes(xintercept = median(vuln), color = "Conservation Network"))+
    geom_vline(data= atlantic_df%>%filter(rcp=="RCP 8.5", location=="Bioregion"), aes(xintercept = median(vuln), color = "Bioregion"))+
    facet_grid(rcp~.)+
    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
    labs(x="Vulnerability",y="",title="Atlantic Ocean",fill="")+
    scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
    theme(axis.text.y=element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.x = element_text(size=15),
          axis.title.x = element_text(size=15),
          legend.position = "bottom",
          plot.title = element_text(size=18),
          legend.text = element_text(size=20),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          strip.text = element_text(size = 18),
          strip.background = element_rect(fill="white")) 
  
  pacific_speed <- ggplot(data=pacific_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
    geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
    facet_grid(rcp~.)+
    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
    labs(x="Vulnerability",y="",title="Pacific Ocean",fill="")+
    scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
    theme(axis.text.y=element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.x = element_text(size=15),
          axis.title.x = element_text(size=15),
          legend.position = "bottom",
          plot.title = element_text(size=18),
          legend.text = element_text(size=20),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          strip.text = element_text(size = 18),
          strip.background = element_rect(fill="white")) 
  

pacific_speed <-  ggplot(data=pacific_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
   geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
  geom_vline(data= pacific_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network"), aes(xintercept = median(vuln), color = "Conservation Network"))+
  geom_vline(data= pacific_df%>%filter(rcp=="RCP 2.6", location=="Bioregion"), aes(xintercept = median(vuln), color = "Bioregion"))+
  geom_vline(data= pacific_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network"), aes(xintercept = median(vuln), color = "Conservation Network"))+
  geom_vline(data= pacific_df%>%filter(rcp=="RCP 8.5", location=="Bioregion"), aes(xintercept = median(vuln), color = "Bioregion"))+
   facet_grid(rcp~.)+
   theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
   coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
   labs(x="Vulnerability",y="",title="Pacific Ocean",fill="")+
   scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
   theme(axis.text.y=element_blank(),
         axis.ticks.y = element_blank(),
         axis.text.x = element_text(size=15),
         axis.title.x = element_text(size=15),
         legend.position = "bottom",
         plot.title = element_text(size=18),
         legend.text = element_text(size=20),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.y = element_blank(),
         strip.text = element_text(size = 18),
         strip.background = element_rect(fill="white"))
  
  arctic_speed <- ggplot(data=arctic_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
    geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
    geom_vline(data= arctic_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network"), aes(xintercept = median(vuln), color = "Conservation Network"))+
    geom_vline(data= arctic_df%>%filter(rcp=="RCP 2.6", location=="Bioregion"), aes(xintercept = median(vuln), color = "Bioregion"))+
    geom_vline(data= arctic_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network"), aes(xintercept = median(vuln), color = "Conservation Network"))+
    geom_vline(data= arctic_df%>%filter(rcp=="RCP 8.5", location=="Bioregion"), aes(xintercept = median(vuln), color = "Bioregion"))+
    facet_grid(rcp~.)+
    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
    labs(x="Vulnerability",y="",title="Arctic Ocean",fill="")+
    scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
    theme(axis.text.y=element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.x = element_text(size=15),
          axis.title.x = element_text(size=15),
          legend.position = "bottom",
          plot.title = element_text(size=18),
          legend.text = element_text(size=20),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          strip.text = element_text(size = 18),
          strip.background = element_rect(fill="white"))
  
  atlantic_speed <- ggplot(data=atlantic_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
    geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
    facet_grid(rcp~.)+
    theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
    coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
    labs(x="Vulnerability",y="",title="Atlantic Ocean",fill="")+
    scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
    theme(axis.text.y=element_blank(),
          axis.ticks.y = element_blank(),
          axis.text.x = element_text(size=15),
          axis.title.x = element_text(size=15),
          legend.position = "bottom",
          plot.title = element_text(size=18),
          legend.text = element_text(size=20),
          panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          strip.text = element_text(size = 18),
          strip.background = element_rect(fill="white"))
 
 all_oceans_wgt <- pacific_plot2 + theme(axis.text.x = element_blank(),
                                         axis.title.x=element_blank()) + labs(x="") + 
   arctic_plot2 + theme(axis.text.x = element_blank(),
                       axis.title.x=element_blank()) + labs(x="") + 
   plot_annotation(title = "Weighted Ocean Plots")+
   atlantic_plot2 + plot_layout(ncol = 3,guides="collect") &
   theme(legend.position = 'bottom') ; all_oceans_wgt
 #--------------------------------------------------------------------------------
 pacific_plot2 <- ggplot(data=pacific_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
   geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
   geom_vline(data= pacific_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network"), aes(xintercept = 0.26, color = "Conservation Network"), show.legend = FALSE, linewidth=1.2)+
   geom_vline(data= pacific_df%>%filter(rcp=="RCP 2.6", location=="Bioregion"), aes(xintercept = 0.27, color = "Bioregion"),show.legend = FALSE,linewidth=1.2)+
   geom_vline(data= pacific_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network"), aes(xintercept = 0.3, color = "Conservation Network"),show.legend = FALSE,linewidth=1.2)+
   geom_vline(data= pacific_df%>%filter(rcp=="RCP 8.5", location=="Bioregion"), aes(xintercept = 0.3, color = "Bioregion"),show.legend = FALSE,linewidth=1.2)+
   facet_grid(rcp~.)+
   theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
   coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
   labs(x="Vulnerability",y="",title="Pacific Ocean",fill="")+
   #scale_x_continuous(labels=scales::percent)+
   scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
   theme(axis.text.y=element_blank(),
         axis.ticks.y = element_blank(),
         axis.text.x = element_text(size=15),
         axis.title.x = element_text(size=15),
         legend.position = "bottom",
         plot.title = element_text(size=18),
         legend.text = element_text(size=20),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.y = element_blank(),
         strip.text = element_text(size = 18),
         strip.background = element_rect(fill="white"))
 
 atlantic_plot2 <- ggplot(data=atlantic_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
   geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
   geom_vline(data= atlantic_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network"), aes(xintercept = 0.31, color = "Conservation Network"),show.legend=FALSE, linewidth=1.2)+
   geom_vline(data= atlantic_df%>%filter(rcp=="RCP 2.6", location=="Bioregion"), aes(xintercept = 0.35, color = "Bioregion"), show.legend=FALSE, linewidth=1.2)+
   geom_vline(data= atlantic_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network"), aes(xintercept = 0.34, color = "Conservation Network"), show.legend=FALSE,linewidth=1.2)+
   geom_vline(data= atlantic_df%>%filter(rcp=="RCP 8.5", location=="Bioregion"), aes(xintercept = 0.35, color = "Bioregion"),show.legend=FALSE,linewidth=1.2)+
   facet_grid(rcp~.)+
   theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
   coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
   labs(x="Vulnerability",y="",title="Atlantic Ocean",fill="")+
   scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
   theme(axis.text.y=element_blank(),
         axis.ticks.y = element_blank(),
         axis.text.x = element_text(size=15),
         axis.title.x = element_text(size=15),
         legend.position = "bottom",
         plot.title = element_text(size=18),
         legend.text = element_text(size=20),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.y = element_blank(),
         strip.text = element_text(size = 18),
         strip.background = element_rect(fill="white"))
 arctic_plot2 <- ggplot(data=arctic_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
   geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
   geom_vline(data= arctic_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network"), aes(xintercept = 0.32, color = "Conservation Network"), show.legend=FALSE, linewidth =1.2)+
   geom_vline(data= arctic_df%>%filter(rcp=="RCP 2.6", location=="Bioregion"), aes(xintercept = 0.38, color = "Bioregion"), show.legend=FALSE, linewidth=1.2)+
   geom_vline(data= arctic_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network"), aes(xintercept = 0.36, color = "Conservation Network"),show.legend =FALSE, linewidth=1.2)+
   geom_vline(data= arctic_df%>%filter(rcp=="RCP 8.5", location=="Bioregion"), aes(xintercept = 0.41, color = "Bioregion"),show.legend =FALSE, linewidth=1.2)+
   facet_grid(rcp~.)+
  # scale_x_continuous(labels=scales::percent)+
   theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
   coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
   labs(x="Vulnerability",y="",title="Arctic Ocean",fill="")+
   scale_fill_discrete(labels = c("Ocean Basin","Conservation Network"))+
   theme(axis.text.y=element_blank(),
         axis.ticks.y = element_blank(),
         axis.text.x = element_text(size=15),
         axis.title.x = element_text(size=15),
         legend.position = "bottom",
         plot.title = element_text(size=18),
         legend.text = element_text(size=20),
         panel.grid.minor.y = element_blank(),
         panel.grid.major.y = element_blank(),
         strip.text = element_text(size = 18),
         strip.background = element_rect(fill="white"))
 
 all_oceans_wgt_2 <- pacific_plot2 + theme(
                                         axis.title.x=element_blank()) + labs(x="") + 
   arctic_plot2 + theme(
                        axis.title.x=element_blank()) + labs(x="") + 
  # plot_annotation(title = "Weighted Ocean Plots")+
   atlantic_plot2 + plot_layout(nrow=3,guides="collect") &
   theme(legend.position = 'bottom') ; all_oceans_wgt_2
  
 #FIGURE 3
 ggsave("output/Figure3_updated.png",all_oceans_wgt_2,height=16,width=16,units="in",dpi=300)
 
#Summary statistics -----
 
 #assemble the dataframes (this is the same as arctic_df,atlantic_df,and arctic_df, but as the addition of the 'outside' to fit your table needs)
 atlantic_sum_df <- bioregion_df%>% 
                     filter(!is.na(adcap),ocean=="Atlantic")%>%
                     mutate(location = "Bioregion",
                            NAME_E = NA)%>%
                     dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                     rbind(.,can_mcn_df%>%
                             filter(!is.na(adcap),ocean=="Atlantic",location=="inside")%>%
                             mutate(location = "Conservation Network")%>%
                             dplyr::select(-c(name,Abbreviation,type)),
                             can_mcn_df%>%
                             filter(!is.na(adcap),ocean=="Atlantic",location=="outside")%>%
                             mutate(location = "outside")%>%
                             dplyr::select(-c(name,Abbreviation,type)))%>%
                     data.frame()%>%
                     dplyr::select(-geometry)
 
 pacific_sum_df <- bioregion_df%>% 
                   filter(!is.na(adcap),ocean=="Pacific")%>%
                   mutate(location = "Bioregion",
                          NAME_E = NA)%>%
                   dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                   rbind(.,can_mcn_df%>%
                           filter(!is.na(adcap),ocean=="Pacific",location=="inside")%>%
                           mutate(location = "Conservation Network")%>%
                           dplyr::select(-c(name,Abbreviation,type)),
                          can_mcn_df%>%
                           filter(!is.na(adcap),ocean=="Pacific",location=="outside")%>%
                           mutate(location = "outside")%>%
                           dplyr::select(-c(name,Abbreviation,type)))%>%
                   data.frame()%>%
                   dplyr::select(-geometry)
 
 arctic_sum_df <- bioregion_df%>% 
                   filter(!is.na(adcap),ocean=="Arctic")%>%
                   mutate(location = "Bioregion",
                          NAME_E = NA)%>%
                   dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                   rbind(.,can_mcn_df%>%
                           filter(!is.na(adcap),ocean=="Arctic",location=="inside")%>%
                           mutate(location = "Conservation Network")%>%
                           dplyr::select(-c(name,Abbreviation,type)),
                          can_mcn_df%>%
                           filter(!is.na(adcap),ocean=="Arctic",location=="outside")%>%
                           mutate(location = "outside")%>%
                           dplyr::select(-c(name,Abbreviation,type)))%>%
                   data.frame()%>%
                   dplyr::select(-geometry)

#weighted means, sd, and median by bioregion 
sum_stats_bioregion <- rbind(atlantic_sum_df,pacific_sum_df,arctic_sum_df)%>%
                       filter(!is.na(vuln))%>%
                       group_by(region,rcp,location)%>%
                       summarise(mean=weighted.mean(vuln,cell_area),
                                 sd=sqrt(wtd.var(vuln,cell_area)),
                                 med = weighted.median(vuln,cell_area))%>%
                       ungroup()%>%
                       data.frame()

#weighted means, sd, and median by ocean 
sum_stats_ocean <- rbind(atlantic_sum_df,pacific_sum_df,arctic_sum_df)%>%
                  filter(!is.na(vuln))%>%
                  group_by(ocean,rcp,location)%>%
                  summarise(mean=weighted.mean(vuln,cell_area),
                            sd=sqrt(wtd.var(vuln,cell_area)),
                            med = weighted.median(vuln,cell_area))%>%
                  ungroup()%>%
                  data.frame()
#weighted means, sd, and median by ocean
sum_stats_mar <- mar_network_df%>%
                  filter(!is.na(vuln))%>%
                  group_by(rcp,location)%>%
                  summarise(mean=weighted.mean(vuln,cell_area),
                            sd=sqrt(wtd.var(vuln,cell_area)),
                            med = median(vuln))%>%
                  ungroup()%>%
                  data.frame()

#save the outputs
write.csv(sum_stats_bioregion,"output/summary_stats_bioregion.csv",row.names=FALSE)
write.csv(sum_stats_ocean,"output/summary_stats_ocean.csv",row.names=FALSE)
   
#------BIOREGIONS----------------------------------------------------------------------------------------------------------------
  
  #trying to separate out the bioregions by adjusting the dataframes
  
rcp85_wgt_region_df <- bioregion_df%>% 
                        filter(!is.na(adcap),rcp=="RCP 8.5")%>%
                        mutate(location = "Bioregion",
                               NAME_E = NA)%>%
                        dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                        rbind(.,can_mcn_df%>%
                                filter(!is.na(adcap),rcp=="RCP 8.5",location=="inside")%>%
                                mutate(location = "Conservation Network")%>%
                                dplyr::select(-c(name,Abbreviation,type)))%>%
                        data.frame()%>% #don't need this to be an 'sf' data.frame anymore. This will speed things up without the geometry column
                        dplyr::select(-geometry)%>% 
                        dplyr::left_join(.,region_abbreviations)

rcp26_wgt_region_df <- bioregion_df%>% 
                        filter(!is.na(adcap),rcp=="RCP 2.6")%>%
                        mutate(location = "Bioregion",
                               NAME_E = NA)%>%
                        dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
                        rbind(.,can_mcn_df%>%
                                filter(!is.na(adcap),rcp=="RCP 2.6",location=="inside")%>%
                                mutate(location = "Conservation Network")%>%
                                dplyr::select(-c(name,Abbreviation,type)))%>%
                        data.frame()%>% #don't need this to be an 'sf' data.frame anymore. This will speed things up without the geometry column
                        dplyr::select(-geometry)%>%
                        dplyr::left_join(.,region_abbreviations)


#density plots ----
rcp85_wgt_density_region <- ggplot(data=rcp85_wgt_region_df,aes(x=vuln, group=location, fill=location)) +
                            facet_wrap(~region, scale="free_y")+
                             theme(legend.position="bottom") +
                             ggtitle("Bioregions under RCP 8.5") +
                             theme_bw() +
                            geom_density()+
                             theme(legend.position="bottom",
                                 panel.spacing = unit(0.1, "lines"),
                                 strip.text.x = element_text(size = 8)) 
                           
 rcp26_wgt_density_region <- ggplot(data=rcp26_wgt_region_df,aes(x=vuln, group=location, fill=location)) +
                               #scale_fill_viridis(discrete = TRUE) +
                               facet_wrap(~region, scale="free_y")+
                               theme(legend.position="bottom") +
                               ggtitle("Bioregions under RCP 2.6") +
                               theme_bw() +
                               geom_density()+
                             theme(legend.position="bottom",
                                   panel.spacing = unit(0.1, "lines"),
                                   strip.text.x = element_text(size = 8)) 
                             
#boxplots
                          
  rcp85_wgt_box_region <- ggplot(data=rcp85_wgt_region_df,aes(x=ab_region,y=vuln,fill=location,weight=cell_area))+
    geom_boxplot()+
    theme_bw()+ylab("Vulnerability")+
    labs(x="",y="Vulnerability",title="RCP 8.5",fill="")+
    facet_wrap(.~factor(ocean, levels = ocean_ord), ncol=1,scales="free_y")+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1,size=18),
          axis.text.y = element_text(size=20),
          legend.position = "bottom", legend.title = element_blank(),
          strip.background = element_rect(fill="white"),
          strip.text = element_text(size=18),
          title = element_text(size=18),
          legend.text = element_text(size=18)
          )+coord_flip()
  
  rcp26_wgt_box_region <- ggplot(data=rcp26_wgt_region_df,aes(x=ab_region,y=vuln,fill=location,weight=cell_area))+
    geom_boxplot()+
    theme_bw()+ylab("Vulnerability")+
    labs(x="",y="Vulnerability",title="RCP 2.6",fill="")+
    facet_wrap(.~factor(ocean, levels = ocean_ord), ncol=1,scales="free_y")+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1,size=18),
          axis.text.y = element_text(size=20),
          legend.position = "bottom", legend.title = element_blank(),
          strip.background = element_rect(fill="white"),
          strip.text = element_text(size=18),
          title = element_text(size=18),
          legend.text = element_text(size=18)
    )+coord_flip()
  

    
  both_rcp_wgt_box_region <- rcp85_wgt_box_region+ 
                              #theme(axis.text.x = element_blank(),axis.title.x=element_blank())+ 
                              labs(x="") + 
                            rcp26_wgt_box_region+ 
                             # theme(axis.text.x = element_blank(), axis.title.x=element_blank()) + 
                              labs("") + 
                               plot_annotation(title = "Bioregional Vulnerability")+
                               plot_layout(nrow = 1,ncol = 2, guides = "collect")&
                              theme(legend.position = 'bottom',legend.text = element_text(size=18))
  
 #Figure 4

  #create medians for each bioregion to be added to the plot
  wgt_region_df_med <- rbind(rcp26_wgt_region_df,rcp85_wgt_region_df)%>%
                       group_by(ocean,location,rcp)%>%
                       summarise(wmed = weighted.median(vuln,cell_area))%>%
                       ungroup()%>%
                       data.frame()%>%
                       mutate(ocean = factor(ocean, levels = ocean_ord))
    
  
  #Figure4_alt ----
  bioregion_box_26 <- ggplot()+
    geom_boxplot(data=rcp26_wgt_region_df,aes(y=region,x=vuln,fill=location,weight=cell_area))+
    theme_bw()+ylab("Vulnerability")+
    labs(y="",x="Vulnerability",title="RCP 2.6",fill="")+
    facet_wrap(.~factor(ocean, levels = ocean_ord), ncol=1,scales="free_y")+
    theme(legend.position = "bottom", legend.title = element_blank(),
          strip.background = element_rect(fill="white"))
  
  bioregion_box_85 <- ggplot()+
    geom_boxplot(data=rcp85_wgt_region_df,aes(y=region,x=vuln,fill=location,weight=cell_area))+
    theme_bw()+ylab("Vulnerability")+
    labs(y="",x="Vulnerability",title="RCP 8.5",fill="")+
    facet_wrap(.~factor(ocean, levels = ocean_ord), ncol=1,scales="free_y")+
    theme(axis.text.y = element_blank(),
          legend.position = "bottom", legend.title = element_blank(),
          strip.background = element_rect(fill="white"))
  
  bioregion_combo_df <- rbind(rcp26_wgt_region_df,rcp85_wgt_region_df)%>%
                        filter(!is.na(vuln))%>%
                        mutate(ocean = factor(ocean, levels = ocean_ord),
                               region = factor(region,levels=bioregion_ord))
  
  bioregion_combo <- ggplot(data=bioregion_combo_df)+
                    geom_vline(data=wgt_region_df_med,aes(xintercept = wmed, linetype=location),show.legend = FALSE,lwd=0.5,col="grey50")+
                    geom_boxplot(aes(y=region,x=vuln,fill=location,weight=cell_area),outlier.size = 0.5)+
                    theme_bw()+
                    scale_linetype_manual(values=c(2,3))+
                    labs(y="",x="Vulnerability",fill="")+
                    facet_grid(ocean~rcp,scales="free_y")+
                    theme(legend.position = "bottom", legend.title = element_blank(),
                          strip.background = element_rect(fill="white"))
  
  ggsave("output/Figure4_updated.png",bioregion_combo,height=8,width=8,units="in",dpi=300)
  
  
   #95% CIs-----------------------------------------------------
  #### MY CODE
  options(max.print = .Machine$integer.max) #set print limit to machine's limit
  
 #applying to individual plots
  location_out <- c("outside")
  location_in <- c("inside")
  bioregions <- c("Western Arctic", "Gulf of Saint Lawrence", "Newfoundland-Labrador Shelves", "Offshore Pacific", "Scotian Shelf", "Northern Shelf", "Arctic Basin", "Strait of Georgia", "Eastern Arctic")
  
  require(plyr)
  df <- data.frame() #create an empty dataframe to add results of each iteration of your loop to
  for(i in bioregions){   ##start of the loop which means do this for all of the bioregions
    
    message(paste0("Working on ",i))                 ##will show what is being done when
    
    m <-  can_mcn_extracts%>%filter(region==i)%>% select(c(vuln,location,rcp,region))%>% # for each bioregion, make a new dataframe without NAs
      data.frame(x = .$vuln, y = .$location, rcp = as.character(.$rcp))%>% #set these as the variables
      na.omit() #assure the function below works by removing NAs
    
    for (l in location_out)
    {
      q <- m%>% filter(rcp=="2.6",y==l)
      f <- function(x){data.frame(v.mean = mean(q$vuln), v.upr = mean(q$vuln)+1.96*(sd(q$vuln)/sqrt(length(q$vuln))), v.lwr = mean(q$vuln)-1.96*(sd(q$vuln)/sqrt(length(q$vuln))))} 
      rcp26 <- ddply(q,.(y,rcp),f)
      
      q <- m%>% filter(rcp=="8.5",y==l)
      rcp85<- ddply(q,.(y,rcp),f)
      
    }
    outside_CIs <- rbind(rcp85,rcp26)
    
    
    for (l in location_in)
    {
      q <- m%>% filter(rcp=="2.6",y==l)
      f <- function(x){data.frame(v.mean = mean(q$vuln), v.upr = mean(q$vuln)+1.96*(sd(q$vuln)/sqrt(length(q$vuln))), v.lwr = mean(q$vuln)-1.96*(sd(q$vuln)/sqrt(length(q$vuln))))} 
      rcp26 <- ddply(q,.(y,rcp),f)
      
      q <- m%>% filter(rcp=="8.5",y==l)
      rcp85<- ddply(q,.(y,rcp),f)
      
    }
    inside_CIs <- rbind(rcp85,rcp26)
    
    all_scenarios<- rbind(outside_CIs,inside_CIs)
    all_scenarios$region<-i
    df <- rbind(df, all_scenarios)  # Using rbind() to append the output of one iteration to the dataframe
      } #kind of clunky but it runs!

  ### PLOTTING ----------------------------------------------------------
  plots <- list()
  library(cowplot)
  for (j in unique(df$region)){
    plot_df <- df[df$region == j, ]
    
    p1 <- ggplot(plot_df, aes(x = y, y = v.mean, group=as.factor(rcp), color=as.factor(rcp)))+
      geom_errorbar(aes(ymin=v.lwr, ymax=v.upr), width=0.6, size=0.5, position=position_dodge(0.3)) +
      geom_point(position=position_dodge(0.3), shape=21, size=2, fill="white")+ 
      labs(title = j, x= "Location", y = "Vulnerability")
    
    p_out <- plot_grid(p1, align = "v", ncol = 1, rel_heights = c(.7, .3))
    
    plots[[j]] <- p_out
    
  }
  require(gridExtra)
  do.call(grid.arrange, plots)
  
  
  #FOR A SINGLE REGION  
  Western_Arctic_df <- can_mcn_extracts %>% filter(region == "Western Arctic")%>%
    select(c(vuln,region,location,rcp))%>%
    data.frame(x = .$vuln, y = .$location, rcp = as.character(.$rcp))%>% #set these as the variables
    na.omit()
  
  q <- Western_Arctic_df%>% filter(rcp=="2.6",y=="inside")
  f <- function(x){data.frame(v.mean = mean(q$vuln), v.upr = mean(q$vuln)+1.96*(sd(q$vuln)/sqrt(length(q$vuln))), v.lwr = mean(q$vuln)-1.96*(sd(q$vuln)/sqrt(length(q$vuln))))} 
  in26 <- plyr::ddply(q,.(y,rcp),f);print(in26)
  
  q <- Western_Arctic_df%>% filter(rcp=="2.6",y=="outside")
  out26<- plyr::ddply(q,.(y,rcp),f);print(out26)
  
  q <- Western_Arctic_df%>% filter(rcp=="8.5",y=="inside")
  in85 <- plyr::ddply(q,.(y,rcp),f);print(in85)
  
  q <- Western_Arctic_df%>% filter(rcp=="8.5",y=="outside")
  out85<- plyr::ddply(q,.(y,rcp),f);print(out85)
  
  rcp26 <- rbind(in26,out26)
  rcp85 <- rbind(in85,out85)
  all_WA_rcps <- rbind(rcp26,rcp85);all_WA_rcps
  
  Western_Arctic_plot <- ggplot(all_WA_rcps, aes(x=y, y=v.mean, group=as.factor(rcp)))+
    labs(title = "Western Arctic",x = "Location", y="Vulnerability")+
    geom_errorbar(aes(ymin=v.lwr, ymax=v.upr), width=0.6, size=0.5, position=pd) +
    geom_point(position=pd, shape=21, size=1, fill="white"); Western_Arctic_plot #it works for a single plot 
  
#trying to fix the fact that all values come out the same...
  
  q <- CI_df%>% filter(rcp=="2.6",y=="inside")
  f <- function(x){data.frame(v.mean = mean(q$vuln), v.upr = mean(q$vuln)+1.96*(sd(q$vuln)/sqrt(length(q$vuln))), v.lwr = mean(q$vuln)-1.96*(sd(q$vuln)/sqrt(length(q$vuln))))} 
  in26 <- plyr::ddply(q,.(y,rcp),f);print(in26)
 
  q <- CI_df%>% filter(rcp=="2.6",y=="outside")
  out26<- plyr::ddply(q,.(y,rcp),f);print(out26)
  
  q <- CI_df%>% filter(rcp=="8.5",y=="inside")
  in85 <- ddply(q,.(y,rcp),f);print(in85)
  
  q <- CI_df%>% filter(rcp=="8.5",y=="outside")
  out85<- ddply(q,.(y,rcp),f);print(out85)
  
  rcp26 <- rbind(in26,out26)
  rcp85 <- rbind(in85,out85)
  all_rcps <- rbind(rcp26,rcp85);all_rcps
  
  all_bioregions <- ggplot(all_rcps, aes(x=y, y=v.mean, group=as.factor(rcp)))+
    labs(title = "All Biorgeions",x="Location",y="Vulnerability")+
    geom_errorbar(aes(ymin=v.lwr, ymax=v.upr), width=0.6, size=0.5, position=pd) +
    geom_point(position=pd, shape=21, size=1, fill="white"); all_bioregions # this works for all bioregions combined
  
#####CHRISTINES CODE
### So if x=vulnerability, and y=inside or outside, and we have a mix of RCPs, lets create a fake example dataset:
xy<-data.frame(vuln=c(0.33,0.34,0.32,0.55,0.65,0.61,0.38, 0.66,0.77,0.78,0.98,0.99,0.56,0.67),y=c("inside", "inside","inside","inside","inside","inside","inside", "outside", "outside","outside","outside","outside","outside","outside"), rcp=as.character(c(2.6,8.5, 2.6,8.5, 2.6,8.5, 2.6,8.5, 2.6,8.5, 2.6,8.5, 2.6,8.5)))

### take a look:
head(xy)
str(xy)  #this shows you that I defined the RCPs as a character variable so that R doesn’t think this is a continuous variable

### Calculate mean and upper and lower bounds of your 95% CI’s (calculated as the mean + and – the standard error) for inside, outside, and both rcps separately using ddply (i.e., applying the function, fn, to each unique instance in column y and column rcp):
fn<-function(x){data.frame(v.mean=mean(x$vuln), v.upr=mean(x$vuln)+1.96*(sd(x$vuln)/sqrt(length(x$vuln))), v.lwr= mean(x$vuln)-1.96*(sd(x$vuln)/sqrt(length(x$vuln))))}
toplot<-plyr::ddply(xy,.(y,rcp),fn)

### take a look:
toplot

### Now plot with the errorbars defined by the CI bounds you calculated above:
pd <- position_dodge(0.3)
ggplot(toplot, aes(x=y, y=v.mean, group=as.factor(rcp)))+
  geom_errorbar(aes(ymin=v.lwr, ymax=v.upr), width=0.6, size=0.5, position=pd) +
  geom_point(position=pd, shape=21, size=1, fill="white")

### You could manually make the error bars thicker and the points larger (type ?geom_errorbar and ?geom_point into your console to see how to change width and size) where there appears to be a significant difference. In this example, the different between inside vs outside is not statistically significant for either of the RCPs, even though the mean vuln outside is almost twice the mean vuln inside. The difference is most prominent under RCP 2.6. (just giving you an example of how you can write about these types of results in your thesis)..

   #FIGURE 3
  ggsave("output/both_rcp_wgt_box_region.png",both_rcp_wgt_box_region,height=6,width=12,units="in",dpi=300)
  
  
  #trying to use plotting orders
  rcp85_wgt_region_df%>%
    mutate(ocean=factor(ocean,levels=bioregion_ord))%>%
  ggplot(.,aes(x=ab_region,y=vuln,fill=location,weight=cell_area))+
    geom_boxplot()+
    theme_bw()+ylab("Vulnerability")+
    labs(x="",y="Vulnerability",title="RCP 8.5",fill="")+
   #facet_wrap(~ocean, scales ="free_y")+
    #facet_wrap(factor(bioregions, levels = bioregion_ord))+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          legend.position = "bottom", legend.title = element_blank(),
          strip.background = element_rect(fill="white"),
    )+coord_flip()

  
 test8.5 <- rcp85_wgt_region_df%>%
            mutate(location = "Conservation Network",
                   name=factor(NAME_E,levels=mpa_ord),
                   region=factor(region,levels=bioregion_ord),
                   ocean=factor(ocean,levels=ocean_ord),
                   rcp=ifelse(rcp==2.6,"RCP 2.6","RCP 8.5"),
                   rcp=factor(rcp,levels=rcp_ord))%>%
    data.frame()%>% 
    dplyr::left_join(.,region_abbreviations)
 
     
#--------DRAFT NETWORK----------------------------------------------------------------------------------------------------------------
     
 #Figure 5 revised (ryan)
 
 mar_network_df_plot <- mar_network_df%>%
                        mutate(location="Bioregion",mar_type="Bioregion")%>% #need to do this because you want to show the network vs the whole region
                        rbind(.,mar_network_df%>%
                                filter(location=="inside")%>%
                                mutate(location="Draft network"))%>%
                        data.frame()%>%
                        filter(!is.na(vuln))%>% #get rid of any NAs still kicking around 
                        dplyr::select(-geometry)%>%#this is the biggest part of the dataframe and it is not needed. Removing makes things faster
                        mutate(type="Draft Network")
 
 mar_network_df_plot_current <- mar_network_df_plot%>%filter(!mar_type %in% c("Draft","AOI"))%>%mutate(type="Current Network")#remove the 'draft' and Areas of Interest (AOI)
 
 mar_combo_data <- rbind(mar_network_df_plot,mar_network_df_plot_current)
 
 mar_network_medians <- mar_network_df_plot%>%
                        group_by(rcp,location)%>%
                        summarise(med=weighted.median(vuln,cell_area))%>% #area weighted median
                        ungroup()%>%
                        data.frame()%>%
                        mutate(type="Draft Network")
 
 mar_network_medians_current <- mar_network_df_plot%>%
                               filter(!mar_type %in% c("Draft","AOI"))%>% #remove the 'draft' and Areas of Interest (AOI)
                               group_by(rcp,location)%>%
                               summarise(med=weighted.median(vuln,cell_area))%>% #area weighted median
                               ungroup()%>%
                               data.frame()%>%
                               mutate(type="Current Network")
 
 mar_network_medians_combo <- rbind(mar_network_medians,mar_network_medians_current)
 
 #plot comparing the region to the existing network
   mar_current <- ggplot()+
                  geom_vline(data=mar_network_medians_current,aes(xintercept=med,col=location),lwd=1.2,show.legend = FALSE)+
                  geom_density(data=mar_network_df_plot%>%filter(!mar_type %in% c("Draft","AOI")), 
                               aes(x=vuln,fill=location,group=location, weight = cell_area),
                               alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
                  facet_grid(rcp~.)+
                   theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
                   coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
                   labs(x="Vulnerability",y="",title="A) Scotian Shelf-Bay of Fundy Network",fill="")+
                    scale_x_continuous(labels=scales::percent)+
                   theme(axis.text.y = element_blank(),
                         axis.ticks.y = element_blank(),
                         legend.position = "bottom", legend.title = element_blank(),
                         strip.background = element_rect(fill="white"));mar_current
   
   #plot the draft network inclusive of existing MPAs, OECMs and AOIs and Draft Sites
   mar_draft <-ggplot()+
               geom_vline(data=mar_network_medians,aes(xintercept=med,col=location),lwd=1.2,show.legend = FALSE)+
               geom_density(data=mar_network_df_plot, 
                            aes(x=vuln,fill=location,group=location, weight = cell_area),
                            alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
               facet_grid(rcp~.)+
               theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
               coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
               labs(x="Vulnerability",y="",title="B) Scotian Shelf-Bay of Fundy Draft Network",fill="")+
               scale_x_continuous(labels=scales::percent)+
               theme(axis.text.y = element_blank(),
                     axis.ticks.y = element_blank(),
                     legend.position = "bottom", legend.title = element_blank(),
                   strip.background = element_rect(fill="white"));mar_draft
 
   #make a plot of both combined using patchwork 
    combo_comparison <- mar_current + mar_draft + plot_layout(nrow=2,guides = "collect") & theme(legend.position="bottom")
    
  #or do a full facet combination -- I think this looks better
    combo_facets <- ggplot()+
      geom_vline(data=mar_network_medians_combo,aes(xintercept=med,col=location),lwd=1.2,show.legend = FALSE)+
      geom_density(data=mar_combo_data , 
                   aes(x=vuln,fill=location,group=location, weight = cell_area),
                   alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
      facet_grid(type~rcp)+
      xlim(0.21,0.45)+
      theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
      coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
      labs(x="Vulnerability",y="",fill="")+
      scale_fill_discrete(labels=c("Bioregion","Network"))+
      #scale_x_continuous(labels=scales::percent)+
      theme(axis.text.y = element_blank(),
            axis.ticks.y = element_blank(),
            legend.position = "bottom", legend.title = element_blank(),
            strip.background = element_rect(fill="white"));combo_facets
    
    ggsave("output/Figure6.png",combo_facets,width=8,height=6,units="in",dpi=300)
  
   
 
 #FIGURE 6
 
     SSBoFdraft_plot <- ggplot(data=mar_network_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
       geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
       geom_vline(data= mar_network_df%>%filter(rcp=="RCP 2.6", location=="inside"), aes(xintercept = median(vuln),color = "inside"))+
       geom_vline(data= mar_network_df%>%filter(rcp=="RCP 2.6", location=="outside"), aes(xintercept = median(vuln), color = "outside"))+
       geom_vline(data= mar_network_df%>%filter(rcp=="RCP 8.5", location=="inside"), aes(xintercept = median(vuln), color = "inside"))+
       geom_vline(data= mar_network_df%>%filter(rcp=="RCP 8.5", location=="outside"), aes(xintercept = median(vuln), color = "outside"))+
       facet_grid(rcp~.)+
       theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
       coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
       labs(x="Vulnerability",y="",title="Scotian Shelf-Bay of Fundy Draft Network",fill="")+
       scale_fill_discrete(labels = c("Outside Draft Network","Within Draft Network"))+
       theme(axis.text.y = element_blank(),
         axis.ticks.y = element_blank(),
         legend.position = "bottom", legend.title = element_blank(),
         strip.background = element_rect(fill="white"))
 
 ggsave("output/SSBoFDraftNetwork.png", SSBoFdraft_plot, width=8,height=8,units="in",dpi=300)

 na.omit(mar_network_df)
 speed_mar_plot <- ggplot(data=mar_network_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
   geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
   facet_grid(rcp~.)+
   theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
   coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
   labs(x="Vulnerability",y="",title="Scotian Shelf-Bay of Fundy Draft Network",fill="")+
   scale_fill_discrete(labels = c("Outside Draft Network","Within Draft Network"))+
   theme(axis.text.y=element_blank(),
           axis.ticks.y = element_blank(),
           axis.text.x = element_text(size=15),
           axis.title.x = element_text(size=15),
           legend.position = "bottom",
           plot.title = element_text(size=18),
           legend.text = element_text(size=20),
           panel.grid.minor.y = element_blank(),
           panel.grid.major.y = element_blank(),
           strip.text = element_text(size = 18),
           strip.background = element_rect(fill="white"))
 
 mar_network_extract1 <- na.omit(mar_network_extract)
       
       mn2.6IN <- mar_network_extract1%>% filter(rcp=="2.6", location =="inside")
       mn2.6OUT <- mar_network_extract1%>% filter(rcp=="2.6", location =="outside")
       mn8.5IN <- mar_network_extract1%>% filter(rcp=="8.5", location =="inside")
       mn8.5OUT <-  mar_network_extract1%>% filter(rcp=="2.6", location =="outside")
      
       medians <- c(median(mn2.6IN$vuln),median(mn2.6OUT$vuln),median(mn8.5IN$vuln),median(mn8.5OUT$vuln))
       means <- c(mean(mn2.6IN$vuln),mean(mn2.6OUT$vuln),mean(mn8.5IN$vuln),mean(mn8.5OUT$vuln))
       rcp <- c("2.6","2.6","8.5","8.5")
       location <- c("inside", "outside", "inside", "outside")
       #TABLE 4
       mar_network_summary_stats <- data.frame(location,rcp,medians,means)

       
#for the regular network (NOT DRAFT)     
       SSBoFnotdraft_df <- bioregion_df%>% 
         filter(!is.na(adcap),region=="Scotian Shelf")%>%
         mutate(location = "Bioregion",
                NAME_E = NA)%>%
         dplyr::select(names(can_mcn_df%>%dplyr::select(-c(name,Abbreviation,type))))%>%
         rbind(.,can_mcn_df%>%
                 filter(!is.na(adcap),region=="Scotian Shelf",location=="inside")%>%
                 mutate(location = "Conservation Network")%>%
                 dplyr::select(-c(name,Abbreviation,type)))
      
        na.omit(SSBoFnotdraft_df)
       
       SSBoFnotdraft_plot <- ggplot(data=SSBoFnotdraft_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
         geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
         geom_vline(data= SSBoFnotdraft_df%>%filter(rcp=="RCP 2.6", location=="Conservation Network"), aes(xintercept = median(vuln), color = "Conservation Network"))+
         geom_vline(data= SSBoFnotdraft_df%>%filter(rcp=="RCP 2.6", location=="Bioregion"), aes(xintercept = median(vuln), color = "Bioregion"))+
         geom_vline(data= SSBoFnotdraft_df%>%filter(rcp=="RCP 8.5", location=="Conservation Network"), aes(xintercept = median(vuln), color = "Conservation Network"))+
         geom_vline(data= SSBoFnotdraft_df%>%filter(rcp=="RCP 8.5", location=="Bioregion"), aes(xintercept = median(vuln), color = "Bioregion"))+
         facet_grid(rcp~.)+
         theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
         coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
         labs(x="Vulnerability",y="",title="Scotian Shelf-Bay of Fundy Current Bioregion",fill="")+
         scale_fill_discrete(labels = c("Bioregion","Conservation Network"))+
         theme(axis.text.y=element_blank(),
               axis.ticks.y = element_blank(),
               axis.text.x = element_text(size=15),
               axis.title.x = element_text(size=15),
               legend.position = "bottom",
               plot.title = element_text(size=18),
               legend.text = element_text(size=20),
               panel.grid.minor.y = element_blank(),
               panel.grid.major.y = element_blank(),
               strip.text = element_text(size = 18),
               strip.background = element_rect(fill="white"))
       
      
       na.omit(mar_network_df)
       
       SSBoFdraft_plot <- ggplot(data=mar_network_df, aes(x=vuln,fill=location,group=location, weight = cell_area))+
         geom_density(alpha = 0.5, color = 4, linetype = 1, lwd = 0.25)+
         geom_vline(data= mar_network_df%>%filter(rcp=="RCP 2.6", location=="inside"), aes(xintercept = median(vuln),color = "inside"))+
         geom_vline(data= mar_network_df%>%filter(rcp=="RCP 2.6", location=="outside"), aes(xintercept = median(vuln), color = "outside"))+
         geom_vline(data= mar_network_df%>%filter(rcp=="RCP 8.5", location=="inside"), aes(xintercept = median(vuln), color = "inside"))+
         geom_vline(data= mar_network_df%>%filter(rcp=="RCP 8.5", location=="outside"), aes(xintercept = median(vuln), color = "outside"))+
         facet_grid(rcp~.)+
         theme_bw()+ #why ggplot insists on adding grey backgrounds is beyond me
         coord_cartesian(expand=0)+ #this gets rid of the white space that ggplot pads the data with
         labs(x="Vulnerability",y="",title="Scotian Shelf-Bay of Fundy Draft Network",fill="")+
         scale_fill_discrete(labels = c("Outside Draft Network","Within Draft Network"))+
         theme(axis.text.y=element_blank(),
               axis.ticks.y = element_blank(),
               axis.text.x = element_text(size=15),
               axis.title.x = element_text(size=15),
               legend.position = "bottom",
               plot.title = element_text(size=18),
               legend.text = element_text(size=20),
               panel.grid.minor.y = element_blank(),
               panel.grid.major.y = element_blank(),
               strip.text = element_text(size = 18),
               strip.background = element_rect(fill="white"))
       
       ggsave("output/SSBoFNotDraft.png",SSBoFnotdraft_plot,width=8,height=8,units="in",dpi=300)
     
     wgt_box_network <- ggplot(data=mar_network_df,aes(x=location,y=vuln,fill=rcp, weight=cell_area))+
       geom_boxplot()+ggtitle("Scotian Shelf-Bay of Fundy Draft Network")+
       theme_bw()+ylab("Vulnerability")+
       theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
             legend.position = "bottom", legend.title = element_blank(),
             strip.background = element_rect(fill="white"))
     
     wgt_box_within_types <- ggplot(data=mar_network_df,aes(x=mar_type,y=vuln,fill = rcp, weight=cell_area))+
       geom_boxplot()+ggtitle("Scotian Shelf-Bay of Fundy Draft Network")+
       theme_bw()+ylab("Vulnerability")+
       theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
             legend.position = "bottom", legend.title = element_blank(),
             strip.background = element_rect(fill="white"))

     wgt_box_network_sites_without_planning_area <-
       mar_network_df %>%
       filter(!is.na(abbreviation)) %>%
      ggplot(aes(x=abbreviation,y=vuln,fill = rcp, weight=cell_area))+
       geom_boxplot(na.rm=TRUE)+ggtitle("Scotian Shelf-Bay of Fundy Draft Network")+
       theme_bw()+ylab("Vulnerability")+
       theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
             legend.position = "bottom", axis.title.x = element_blank(),legend.title = element_blank(),
             strip.background = element_rect(fill="white"))
       
     
     all_SSBoF<- speed_mar_plot + theme(legend.position="none") + labs(title ="A") +
       SSBoFnotdraft_plot + theme(legend.position="none") + labs(title = "B") +
       plot_layout(nrow=2)
     
#vulnerability classification --------------------
     
#------------DEPTH--------------------------------------------------------------------------------------------------------------
     max_depth <- plyr::round_any(min(can_mcn_df$bathy,na.rm=TRUE)*-1,100)
     
     shelf_break <- -250
     
     breaks_simple <- c(0,50,100,250,500,max_depth)
     
     breaks_simple_df <- data.frame(lower=breaks_simple[1:(length(breaks_simple)-1)],
                                    upper=breaks_simple[2:length(breaks_simple)])%>%
       dplyr::mutate(label=paste0(lower,"-",upper," m"), #tell it what to label the depths
              interval=0:(n()-1))
     
     depth_comp <- rbind(atlantic_df,pacific_df,arctic_df)%>%
         data.frame()%>%
         dplyr::select(-geometry)%>%
         filter(!is.na(bathy))%>%
         mutate(depth=bathy*-1,
                interval = 
        findInterval(depth,breaks_simple[2:length(breaks_simple)]))%>%
         left_join(breaks_simple_df)%>%
         group_by(ocean,location,label)%>%
         dplyr::summarise(area=sum(cell_area))%>%
         ungroup()%>%
         group_by(ocean,location)%>%
         mutate(prop_area=area/sum(area))%>%
         ungroup()%>%
         mutate(location=ifelse(location=="Conservation Network","Network",location))%>%
         dplyr::select(-area)%>%
         spread(location,prop_area)%>%
         left_join(breaks_simple_df)%>%
         mutate(Network = ifelse(is.na(Network),0,Network), #depths aren't within that range
                Bioregion = ifelse(is.na(Bioregion),0,Bioregion),
                differential=Network-Bioregion,
                depth=upper*-1,
                label=factor(label,levels=rev(breaks_simple_df%>%pull(label))),
                ocean=factor(ocean,levels=ocean_ord))
     
     depth_prop_comp <- ggplot()+
               geom_point(data=depth_comp,aes(x=label,y=differential,col=differential),size=3)+
               geom_hline(yintercept=0)+
               geom_vline(xintercept=shelf_break*-1,lty=2)+
               geom_segment(data=depth_comp,aes(x=label,xend=label,y=0,yend=differential,col=differential),lwd=1)+
               theme_bw()+
               facet_wrap(~ocean)+
               scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
               scale_color_viridis_c(option="C")+
               coord_flip()+
               labs(y="Proportional differential",x="",col="")+
               theme(legend.position = "none",
                     strip.background = element_rect(colour = "black", fill = "white"),
                     strip.text.x = element_text(colour = "black"),
                     axis.text.y = element_text(colour = "black"),
                     axis.text.x = element_text(colour = "black",size=8))
     
     #ggsave("output/depth_prop_comp.png",depth_prop_comp,width=6,height=6,units="in",dpi=300)
     
    depth_bar <-rbind(atlantic_df,pacific_df,arctic_df)%>%
                data.frame()%>% #make the ocean dfs into one single df
                dplyr::select(-geometry)%>% #remove geometry column
                filter(!is.na(bathy))%>% #look at depth
                mutate(depth=bathy*-1, #make it positive
                       interval = findInterval(depth,breaks_simple[2:length(breaks_simple)]))%>%
                left_join(breaks_simple_df)%>% #take that depth divided df and add it to the oceans df
                group_by(ocean,location,label)%>% #sort it by ocean, in/out, and that depth
                dplyr::summarise(area=sum(cell_area))%>% #show all area for each ocean, in/out, and depth
                ungroup()%>%
                group_by(ocean,location)%>%
                mutate(prop_area = area/sum(area))%>% #show % area for each ocean 
                ungroup()%>%
                data.frame()%>%
                mutate(label=factor(label,levels=rev(breaks_simple_df%>%pull(label))),
                       ocean=factor(ocean,levels=c("Pacific","Arctic","Atlantic"))) 
  
    depth_barplot <- ggplot(depth_bar%>%filter(location=="Conservation Network"))+
      geom_bar(aes(x=label,y=prop_area,fill=label),stat="identity",col="black")+
      facet_wrap(~ocean,ncol=3)+
      labs(y="% area within network",x="")+
      #scale_y_continuous(labels = percent_format)+
      scale_y_continuous(labels = scales::percent_format(accuracy=1))+
      coord_flip()+
      scale_fill_viridis(discrete=T)+
      theme_bw()+
      theme(legend.position = "none",
            strip.background = element_rect(colour = "black", fill = "white"),
            strip.text.x = element_text(colour = "black"),
            axis.text.y = element_text(colour = "black"),
            axis.text.x = element_text(colour = "black",size=8));depth_barplot
    
   # ggsave("output/depth_aggbar_comp.png",depth_barplot,width=8,height=6,units="in",dpi=300)
      
    by_depth <- ggplot(depth_bar%>%filter(location=="Bioregion"))+
      geom_bar(aes(x=label,y=area,fill=label),stat="identity",col="black")+
      facet_wrap(~ocean,ncol=3)+
      labs(y="bioregion area overall",x="")+
      #scale_y_continuous(labels = percent_format)+
      scale_y_continuous(labels = scales::percent_format())+
      coord_flip()+
      scale_fill_viridis(discrete=T)+
      theme_bw()+
      theme(legend.position = "none",
            strip.background = element_rect(colour = "black", fill = "white"),
            strip.text.x = element_text(colour = "black"),
            axis.text.y = element_text(colour = "black"),
            axis.text.x = element_text(colour = "black",size=8));by_depth
    
## depth vs vulnerabilty 
    depth_vuln <- rbind(atlantic_df,pacific_df,arctic_df)%>%
      data.frame()%>%
      dplyr::select(-geometry)%>%
      filter(!is.na(bathy))%>%
      mutate(depth=bathy*-1,
             interval = 
               findInterval(depth,breaks_simple[2:length(breaks_simple)]))%>%
      left_join(breaks_simple_df)%>%
      mutate(label=factor(label,levels=rev(breaks_simple_df%>%pull(label))),
             ocean=factor(ocean,levels=c("Pacific","Arctic","Atlantic")),
             region = factor(region,levels = bioregion_ord)) 
    
    depth_vuln_med <- depth_vuln%>%
      group_by(rcp,ocean,label)%>%
      summarise(med=weighted.median(vuln,cell_area))%>%
      ungroup()%>%
      data.frame()
    
    vuln_depth <- ggplot(depth_vuln)+
      geom_boxplot(aes(x=label,y=vuln,fill=label),col="black")+
      facet_grid(rcp~ocean)+
      labs(y="Vulnerability",x="")+
      coord_flip()+
      scale_fill_viridis(discrete=T)+
      theme_bw()+
      theme(legend.position = "none",
            strip.background = element_rect(colour = "black", fill = "white"),
            strip.text.x = element_text(colour = "black"),
            axis.text.y = element_text(colour = "black"),
            axis.text.x = element_text(colour = "black",size=8));vuln_depth
    
    vuln_depth_26 <- ggplot(depth_vuln%>%filter(rcp=="RCP 2.6"))+
      geom_boxplot(aes(x=label,y=vuln,fill=label),col="black")+
      facet_grid(rcp~ocean)+
      labs(y="Vulnerability",x="")+
      coord_flip()+
      scale_fill_viridis(discrete=T)+
      theme_bw()+
    theme(legend.position = "none",
          strip.background = element_blank(),
          strip.text = element_blank(),
          axis.text.y= element_blank(),
          axis.text.x = element_text(colour = "black",size=8))
    
    vuln_depth_85 <- ggplot(depth_vuln%>%filter(rcp=="RCP 8.5"))+
      geom_boxplot(aes(x=label,y=vuln,fill=label),col="black")+
      facet_grid(rcp~ocean)+
      labs(y="Vulnerability",x="")+
      coord_flip()+
      scale_fill_viridis(discrete=T)+
      theme_bw()+
      theme(legend.position = "none",
            strip.background = element_blank(),
            strip.text = element_blank(),
            axis.text.y = element_text(colour = "black"),
            axis.text.x = element_text(colour = "black",size=8))

  #make an aggregate for figure 7
    
 combo_fig7 <- ((depth_barplot+theme(axis.text.x = element_text(colour = "black",size=5))+labs(title="A)",y="Network area")) + (depth_prop_comp + theme(axis.text.y = element_blank(),axis.text.x = element_text(colour = "black",size=5)) + labs(title="B)")) + plot_layout(ncol=2)) / 
                ((vuln_depth_85 + labs(title="C)  RCP 8.5")) + (vuln_depth_26 + labs(title="D)  RCP 2.6")) + plot_layout(ncol=2))
  
  
 ggsave("output/Figure7_updated.png",combo_fig7,height=8,width=9,units="in",dpi=300)
     

keep <- c("MPA", "OECM")

full_depth_summary <- can_mcn_df%>%
                      select(bathy:cell_area)%>% 
                      filter(type %in% keep)%>% 
                      group_by(NAME_E)%>%
                      summarize(mean_depth = mean(bathy, na.rm = TRUE),
                       max_depth = min(bathy))


test <- can_mcn_df%>%
        select(bathy:cell_area)

full_depth_summary <- test%>%
                      filter(type %in% keep)%>% 
                      group_by(NAME_E)%>%
                      summarize(mean_depth = mean(bathy, na.rm = TRUE),
                                max_depth = min(bathy))

mpa_oecm_depths <- ggplot(full_depth_summary, aes(x=max_depth)) + 
              xlim(-5500,-20)+ #excluding extremely shallow depths to see if that gives me a better outcome, but don't really think this is the answer to the issue
              ylim(0,8)+
              geom_histogram(bins = 6)+
              labs(x="Bathymetry (in m)", y="Number of MPAs/OECMs",
                   title="Max MPA & OECM Depths")

#this graph technically looks better I guess?? but this is after lots of manipulation so it seems wrong


#code for only MPAs 
MPA_depth_summary <- can_mcn_df%>%
                    filter(type == "MPA")%>%
                    group_by(NAME_E)%>%
                    summarize(mean_depth = mean(bathy, na.rm = TRUE),
                              max_depth = min(bathy))

                    
     #MPA plot
ggplot(MPA_depth_summary, aes(x=max_depth)) + 
     geom_histogram()+
     labs(x="Bathymetry", 
          title="Max MPA Depths")
                  
#FIGURE 5   
  bathy_vuln_initial <- ggplot(can_mcn_df, aes(x=bathy, y=vuln)) + 
       geom_point(aes(col=bathy)) +
       geom_smooth(method="loess", se=F) + theme_bw()+
       labs(y="Vulnerability", 
            x="Bathymetry (in m)", 
            title="Depth Vs Vulnerability")
  
  
  
  library(ggalt)
  library(ggpubr)
  library(ggExtra)
  library(ggcorrplot)
  
  m <- ggplot(can_mcn_df, aes(x=bathy, y=vuln)) + 
    geom_count() + 
    geom_smooth(method="lm", se=F); m
  
  ggMarginal(m, type = "histogram", fill="transparent")
  ggMarginal(m, type = "boxplot", fill="transparent")
  
 
  data(can_mcn_df)
  corr <- round(cor(can_mcn_df), 1)
  ggcorrplot(corr, hc.order = TRUE, 
             type = "lower", 
             lab = TRUE, 
             lab_size = 3, 
             method="circle", 
             colors = c("tomato2", "white", "blue3"), 
             title="Correlogram of depth and vulnerability", 
             ggtheme=theme_bw)
  
  j <- can_mcn_df%>% 
    filter(location=="inside")%>%
    data.frame()%>% #don't need this to be an 'sf' data.frame anymore. This will speed things up without the geometry column
    dplyr::select(-geometry)
    
    q <- ggplot(j, aes(x=bathy, y=vuln, color=vuln, size=bathy)) +
    geom_point() + 
      #xlim(-1000,0)+
    theme(legend.position="bottom")
  
  # with marginal histogram
  p2 <- ggMarginal(q, type="histogram");p2
  
  
  
so_far <- depth_comp%>%
    dplyr::select(-geometry)%>%
    filter(!is.na(bathy))%>%
    mutate(depth=bathy*-1,
           interval = findInterval(depth,breaks_simple[2:length(breaks_simple)]))%>%
    left_join(breaks_simple_df)%>%
  
  second <- so_far%>%
    group_by(ocean,location,label)%>%
    summarise(area=sum(cell_area))%>%
    ungroup()%>%
  
  second%>%
    group_by(ocean,location)%>%
    mutate(prop_area=area/sum(area))%>%
    ungroup()%>%
    mutate(location=ifelse(location=="Conservation Network","Network",location))%>%
    dplyr::select(-area)%>%
    spread(location,prop_area)%>%
    left_join(breaks_simple_df)%>%
    mutate(Network = ifelse(is.na(Network),0,Network), #depths aren't within that range
           Bioregion = ifelse(is.na(Bioregion),0,Bioregion),
           differential=Network-Bioregion,
           depth=upper*-1,
           label=factor(label,levels=rev(breaks_simple_df%>%pull(label))))
  
## Risk classifiation analysis based on Boyce et al. --------------------------------

risk_class_df <- can_mcn_df%>%
  data.frame()%>%
  dplyr::select(-geometry)%>%
  filter(!is.na(vuln))%>%
  mutate(risk_cat = case_when(vuln<0.25 ~ "Negligible",
                              vuln>=0.25 & vuln<0.44 ~ "Moderate",
                              vuln>=0.44 & vuln<0.65 ~ "High",
                              TRUE ~ "Critical"))%>%
  left_join(.,area_df)

risk_class_ocean_df <- risk_class_df%>%
  group_by(rcp,ocean,region,location,risk_cat)%>%
  summarise(area = sum(cell_area,na.rm=T),
            region_area = unique(region_area),
            ocean_area = unique(ocean_area),
            location_area = unique(location_area),
            area_prop = area/location_area,
            ocean_area_prop = area/ocean_area)%>%
  ungroup()%>%
  mutate(ocean=factor(ocean,levels=ocean_ord),
         region=factor(region,levels=bioregion_ord),
         risk_cat = factor(risk_cat,levels=c("Negligible","Moderate","High")))


ggplot(risk_class_ocean_df%>%filter(rcp=="RCP 2.6"),
       aes(y=region,x=area,fill=risk_cat))+
  geom_bar(stat="identity",position="fill",col="black")+
  facet_grid(ocean~location,scales="free_y")+
  scale_x_continuous(labels=percent)+
  theme_bw()+
  theme(strip.background.x = element_rect(fill="white"),
        strip.background.y = element_blank(),
        strip.text.y = element_blank())+
  labs(x="Proportion area",y="",fill="Risk category",title="RCP 2.6")->risk_cat_26

ggplot(risk_class_ocean_df%>%filter(rcp=="RCP 8.5"),
       aes(y=region,x=area,fill=risk_cat))+
  geom_bar(stat="identity",position="fill",col="black")+
  facet_grid(ocean~location,scales="free_y")+
  scale_x_continuous(labels=percent)+
  scale_fill_discrete(drop = FALSE)+
  theme_bw()+
  theme(strip.background = element_rect(fill="white"),
        axis.text.y = element_blank())+
  labs(x="Proportion area",y="",fill="Risk category",title="RCP 8.5")->risk_cat_85

combo_risk_plot <- risk_cat_26 + risk_cat_85 + plot_layout(ncol=2,guides = 'collect') & theme(legend.position = "bottom",axis.text.x = element_text(size=6))

ggsave("output/combo_risk_plot.png",combo_risk_plot,height=6,width=8,units="in",dpi=300)


eez_risk <- risk_class_df%>%
  mutate(eez = sum(cell_area,na.rm=T)/2)%>%
  group_by(rcp,risk_cat)%>%
  summarise(eez_risk = sum(cell_area,na.rm=T)/unique(eez))%>%
  ungroup()%>%
  left_join(.,
            risk_class_df%>%
              filter(location == "inside")%>%
              mutate(total_area = sum(cell_area,na.rm=T)/2)%>%
              group_by(rcp,risk_cat)%>%
              summarise(mcn_risk = sum(cell_area,na.rm=T)/unique(total_area))%>%
              ungroup())%>%
  mutate(differential = mcn_risk - eez_risk,
         rcp=factor(rcp,levels=rev(rcp_ord)),
         region="Canada",
         risk_cat = factor(risk_cat,levels=c("Negligible","Moderate","High")),
         ocean="EEZ")


ggplot(data=eez_risk,aes(x=differential,y=risk_cat))+
  geom_vline(xintercept = 0,lty=2)+
  geom_point()+
  geom_segment(aes(x=0,xend=differential,y=risk_cat,yend=risk_cat))+
  theme_bw()+
  facet_wrap(~rcp,ncol=2)+
  scale_x_continuous(labels=percent)+
  labs(x="Proportional difference",y="")+
  theme(strip.background = element_rect(fill="white"))

ggplot(data=eez_risk%>%mutate(type="EEZ"),aes(x=differential,y=risk_cat))+
  geom_vline(xintercept = 0,lty=2)+
  geom_segment(aes(x=0,xend=differential,y=risk_cat,yend=risk_cat,col=rcp))+
  geom_point(aes(col=rcp),size=2)+
  facet_wrap(~type,ncol=1)+
  theme_bw()+
  scale_x_continuous(labels=percent)+
  labs(x="Proportional difference",y="")+
  theme(strip.background = element_rect(fill="white"),
        legend.position="bottom")

bioregion_risk <- risk_class_df%>%
  group_by(rcp,region,risk_cat)%>%
  summarise(region_risk = sum(cell_area,na.rm=T)/unique(region_area))%>%
  ungroup()%>%
  left_join(.,
            risk_class_df%>%
              filter(location == "inside")%>%
              group_by(rcp,region,risk_cat)%>%
              summarise(mcn_risk = sum(cell_area,na.rm=T)/unique(location_area))%>%
              ungroup())%>%
  mutate(mcn_risk = ifelse(is.na(mcn_risk),0,mcn_risk),
         differential = mcn_risk - region_risk)%>%
  left_join(.,area_df%>%dplyr::select(ocean,region)%>%distinct(region,.keep_all=T))%>%
  mutate(rcp=factor(rcp,levels=rev(rcp_ord)),
         risk_cat = factor(risk_cat,levels=c("Negligible","Moderate","High")),
         region=factor(region,levels=bioregion_ord),
         ocean=factor(ocean,levels=ocean_ord))


ggplot(data=bioregion_risk,aes(x=differential,y=risk_cat))+
  geom_vline(xintercept = 0,lty=2)+
  geom_point(aes(col=rcp),size=2)+
  geom_segment(aes(x=0,xend=differential,y=risk_cat,yend=risk_cat,col=rcp))+
  theme_bw()+
  facet_wrap(~region,ncol=2)+
  scale_x_continuous(labels=percent)+
  labs(x="Proportional difference",y="")+
  theme(strip.background = element_rect(fill="white"))


risk_plot_df <- bioregion_risk%>%
  mutate(differential = ifelse(region %in% c('Southern Shelf','Hudson Bay Complex','Arctic Archipelago'),NA,differential))%>%
  dplyr::select(c(ocean,region,rcp,risk_cat,differential))%>%
  rbind(.,eez_risk%>%dplyr::select(c(ocean,region,rcp,risk_cat,differential)))%>%
  mutate(ocean=factor(ocean,levels=c(ocean_ord,"EEZ")))


risk_canada_plot <- ggplot(data=risk_plot_df,aes(x=differential,y=region))+
  geom_vline(xintercept = 0,lty=2,lwd=0.8)+
  geom_segment(aes(x=0,xend=differential,y=region,yend=region,col=rcp))+
  geom_point(aes(col=rcp),size=2)+
  theme_bw()+
  facet_grid(ocean~risk_cat,scales="free_y")+
  scale_x_continuous(labels=percent)+
  labs(x="Proportional difference",y="",col="")+
  theme(strip.background = element_rect(fill="white"),
        legend.position="bottom");risk_canada_plot

#or just he bioregions
risk_bioregion_plot <- ggplot(data=bioregion_risk%>%
                                mutate(differential = ifelse(region %in% c('Southern Shelf','Hudson Bay Complex','Arctic Archipelago'),
                                                             NA,differential)),aes(x=differential,y=region))+
  geom_vline(xintercept = 0,lty=2,lwd=0.8)+
  geom_segment(aes(x=0,xend=differential,y=region,yend=region,col=rcp))+
  geom_point(aes(col=rcp),size=2)+
  theme_bw()+
  facet_grid(ocean~risk_cat,scales="free_y")+
  scale_x_continuous(labels=percent)+
  labs(x="Proportional difference",y="",col="")+
  theme(strip.background = element_rect(fill="white"),
        legend.position="bottom");risk_bioregion_plot

ggsave("output/risk_bioregion_plot.png",risk_bioregion_plot,height=6,width=7,units="in",dpi=300)
ggsave("output/risk_canada_plot.png",risk_canada_plot,height=7,width=7,units="in",dpi=300)
