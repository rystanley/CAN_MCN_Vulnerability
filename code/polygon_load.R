#Polygon load -- this is a function to load in and format polygons needed for various analyses. Since this
#code is shared among steps we can avoid re-writing it in each code chunk by implementing it as a function

polygon_load <- function(){
  
  message("Loading polygons for the MCN Vulnerability analysis")

library(dplyr)
library(ggplot2)
library(patchwork)
library(ggridges) #best plots so far 
library(sf)
library(patchwork)
library(rnaturalearth)
#library(gghalves)

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

#load conservation network polygons ---------
can_eez <- read_sf("data/shapefiles/Canada_EEZ.shp")%>%st_transform(CanProj)

can_bioregions <- read_sf("data/shapefiles/DFO_Marine_Bioregions_Clipped_1M_CAEAC_2012_05_31.shp")%>%
  st_transform(CanProj)%>%
  rowwise()%>%
  mutate(region=as.character(Legend), #fix up the wierd format that the legends were captured
         region=strsplit(region,"/",fixed=TRUE)[[1]][1],
         region=gsub("\\.","",region),
         region=gsub("[0-9]+","",region),
         region=trimws(region))%>%
  filter(region != "Saint-Pierre et Miquelon")%>%
  ungroup()%>%
  st_as_sf()%>%
  dplyr::rename(ocean=REGION)%>%
  filter(ocean != "Great Lakes")%>%
  dplyr::select(ocean,region,geometry)

mar_network1 <- read_sf("data/shapefiles/networksites_proposed_OEM_MPA_20220617.shp")%>%
  st_transform(CanProj)%>%
  mutate(type = ifelse(TYPE == "TBD","Draft",TYPE),
         type = ifelse(type == "OEM","OECM",type))%>%
dplyr::rename(mar_name = NAME,
         mar_type = type)%>% #easier name that doesn't overlap with other names from other dataframes
  dplyr::select(mar_name,mar_type,geometry)

mar_network <- mar_network1%>%
  group_by(mar_name)%>%
  summarise(geometry=st_union(geometry))%>% # to unify the Western Emerald Bank Polygon
  ungroup()%>%
  st_as_sf()%>%
  left_join(.,mar_network1%>%
              data.frame()%>%
              dplyr::select(-geometry)%>%
              distinct(mar_name,.keep_all=T))

mar_region <- read_sf("data/shapefiles/MaritimesPlanningArea.shp")%>%
  st_transform(CanProj)%>% #note this is slightly different than the bioregions but pretty close
  dplyr::rename(mar_region=Name) #simplified name

Canada <-  ne_states(country = "Canada",returnclass = "sf")%>%
  dplyr::select(name_en,geometry)%>%
  st_as_sf()%>%
  st_union()%>%
  st_transform(CanProj)%>%
  st_as_sf()%>%
  mutate(country="Canada")

can_mcn <- read_sf("data/shapefiles/All_GoC_MCAs.shp")%>%
  st_transform(CanProj)%>%
  mutate(type=TYPE_E)%>%
  filter(BIOME == "M")

can_mcn <- can_mcn%>%
  group_by(NAME_E)%>%
  summarise(geometry=st_union(geometry))%>%
  ungroup()%>%
  left_join(.,can_mcn%>%data.frame()%>%distinct(NAME_E,.keep_all = TRUE)%>%dplyr::select(-geometry))%>%
  dplyr::select(NAME_E,type,geometry)%>% #keep the syntax the same. 
  st_make_valid()

#identify the regions assocaited with each MPA for later analysis. 
can_mcn_regions <- can_mcn%>%
  st_centroid()%>%
  st_join(.,can_bioregions,join=st_is_within_distance,dist=10000)%>% #the centroids for Musquash/Gilbert Bay are on land based on the resoluiton of the bioregions and Anguniaqvia centroid is on land
  st_transform(latlong)%>%
  mutate(clat=st_coordinates(.)[,2], #centroid 'c' lat and longs
         clong=st_coordinates(.)[,1])%>%
  data.frame()%>%
  mutate(ocean = ifelse(NAME_E == "Saguenay Fjord Upstream Closure","Atlantic",ocean), 
         region = ifelse(NAME_E == "Saguenay Fjord Upstream Closure","Gulf of Saint Lawrence",region))%>%# Saguenay Fjord Upstream closure centriod is  far inland and outside the polygon
  arrange(ocean,region,clat)%>%
  dplyr::select(NAME_E,type,ocean,region,clat,clong)

#still a few that wrap around islands that are not associted with the marine side
can_mcn_missing_regions <- can_mcn_regions%>%
                           filter(is.na(region))%>%
                           data.frame()%>%
                           st_as_sf(coords=c("clong","clat"),crs=latlong)%>%
                           st_transform(CanProj)%>%
                           mutate(match_feature = st_nearest_feature(.,can_bioregions),#returns index that can be used to grab the right values
                                  region = data.frame(can_bioregions)[match_feature,"region"],
                                  ocean = data.frame(can_bioregions)[match_feature,"ocean"])

#fill in the gaps
can_mcn_regions[match(can_mcn_missing_regions$NAME_E,can_mcn_regions$NAME_E),c("region","ocean")] <- can_mcn_missing_regions%>%
                                                                                                     data.frame()%>%dplyr::select(region,ocean)


#create a map boundary for the analysis based on the Canadian EEZ
can_bounding <- can_eez%>%
  st_transform(latlong)%>%
  st_buffer(2)%>% #2 degree buffer on the Canadian EEZ extent
  st_transform(CanProj)%>%
  st_bbox() #bounding box used for plot limits #will give some warnings but it doesn't distort the bounding box by much and it's only a bounding box anyway

can_bounding_polygon <- can_bounding%>%st_as_sfc()%>%st_as_sf() #convert to an sf polygon

mar_bound <- mar_region%>%
  st_bbox()

#create a basemap for plotting MPAs
basemap <- rbind(ne_states(country = "Canada",returnclass = "sf")%>%
                   dplyr::select(name_en,geometry)%>%
                   st_as_sf()%>%
                   st_union()%>%
                   st_transform(latlong)%>%
                   st_as_sf()%>%
                   mutate(country="Canada"),
                 ne_states(country = "United States of America",returnclass = "sf")%>%
                   dplyr::select(name_en,geometry)%>%
                   st_as_sf()%>%
                   st_union()%>%
                   st_transform(latlong)%>%
                   st_as_sf()%>%
                   mutate(country="USA"),
                 ne_states(country = "Greenland",returnclass = "sf")%>%
                   dplyr::select(name_en,geometry)%>%
                   st_as_sf()%>%
                   st_union()%>%
                   st_transform(latlong)%>%
                   st_as_sf()%>%
                   mutate(country="USA"))%>%
  st_union()%>%
  st_as_sf()%>%
  st_transform(CanProj)%>%
  st_intersection(.,can_bounding_polygon)


#return the polygons by assigning them to the workspace
return_items <- list(can_mcn,can_mcn_regions,mar_network,mar_region,Canada,can_bioregions,can_eez,latlong,CanProj,basemap,can_bounding)
return_names <- c("can_mcn","can_mcn_regions","mar_network","mar_region","Canada","can_bioregions","can_eez","latlong","CanProj","basemap","can_bounding")

for(i in 1:length(return_items)){
  
  assign(return_names[i], return_items[[i]], envir=.GlobalEnv)
  
}

}#end function