#Spatial Intersections

library(sf)
library(dplyr)
library(raster)
library(ggplot2)
library(tidyr)
library(rnaturalearth)
library(patchwork)

sf_use_s2(FALSE) #makes some of the sf functions run a bit less buggy

#Projections ------------
latlong <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
CanProj <- "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=63.390675 +lon_0=-91.86666666666666 +x_0=6200000 +y_0=3000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"

#load polygons
can_eez <- read_sf("data/shapefiles/Canada_EEZ.shp")%>%st_transform(CanProj)

can_bioregions <- read_sf("data/shapefiles/DFO_Marine_Bioregions_Clipped_1M_CAEAC_2012_05_31.shp")%>%
  st_transform(CanProj)%>%
  rowwise()%>%
  mutate(region=as.character(Legend), #fix up the wierd format that the legends were captured
         region=strsplit(region,"/",fixed=TRUE)[[1]][1],
         region=gsub("\\.","",region),
         region=gsub("[0-9]+","",region),
         region=trimws(region))%>%
  filter(region != "Saint-Pierre et Miquelon")%>%
  ungroup()%>%
  st_as_sf()%>%
  rename(ocean=REGION)%>%
  filter(ocean != "Great Lakes")%>%
  dplyr::select(ocean,region,geometry)

mar_network <- read_sf("data/shapefiles/networksites_proposed_OEM_MPA_20220617.shp")%>%
  st_transform(CanProj)%>%
  mutate(type = ifelse(TYPE == "TBD","Draft",TYPE),
         type = ifelse(type == "OEM","OECM",type))%>%
  rename(mar_name = NAME,
         mar_type = type)%>% #easier name that doesn't overlap with other names from other dataframes
  dplyr::select(mar_name,mar_type,geometry)

mar_region <- read_sf("data/shapefiles/MaritimesPlanningArea.shp")%>%
              st_transform(CanProj)%>% #note this is slightly different than the bioregions but pretty close
              rename(mar_region=Name) #simplified name

Canada <-  ne_states(country = "Canada",returnclass = "sf")%>%
  dplyr::select(name_en,geometry)%>%
  st_as_sf()%>%
  st_union()%>%
  st_transform(CanProj)%>%
  st_as_sf()%>%
  mutate(country="Canada")

can_mcn <- read_sf("data/shapefiles/All_GoC_MCAs.shp")%>%
           st_transform(CanProj)%>%
           mutate(type=TYPE_E)%>%
            dplyr::select(NAME_E,type,geometry) #keep the syntax the same. 

#read in the datafiles and intersect with the Canadian MCN polys ** note we might want to buffer these to get values for the smallest sites
rcp_26 <- read.csv("data/climate_vulnerability_26.csv")%>%
          st_as_sf(coords=c("lon","lat"),crs=latlong)%>% #converts this to an 'sf' dataframe
          st_transform(CanProj)%>% #convert to the coordinate reference system used by our shapefiles for canada
          st_join(.,can_mcn,left=TRUE)%>%#intersect with Canadian Marine Conservation Areas
          st_join(.,can_bioregions,left=TRUE)%>%#intersect with the Canadian Bioregions and 'Oceans'
          st_join(.,mar_network,left=TRUE)%>% #add new columns flagging Maritimes sites. 
          st_join(.,mar_region,left=TRUE)%>% # intersect with the maritimes region planning area 
          rename(name=NAME_E)%>% #the 'NAME_E' is taken from the MPA shapefile but is harder to type so we simplify here.
          filter(!is.na(ocean)) # gets rid of the points in the French Territory (St. Peirre)

rcp_85 <- read.csv("data/climate_vulnerability_85.csv")%>%
          st_as_sf(coords=c("lon","lat"),crs=latlong)%>% #converts this to an 'sf' dataframe
          st_transform(CanProj)%>% #convert to the coordinate reference system used by our shapefiles for canada
          st_join(.,can_mcn,left=TRUE)%>%#intersect with Canadian Marine Conservation Areas
          st_join(.,can_bioregions,left=TRUE)%>%#intersect with the Canadian Bioregions and 'Oceans'
          st_join(.,mar_network,left=TRUE)%>% #add new columns flagging Maritimes sites.
          st_join(.,mar_region,left=TRUE)%>% # intersect with the maritimes region planning area 
          rename(name=NAME_E)%>% #the 'NAME_E' is taken from the MPA shapefile but is harder to type so we simplify here.
          filter(!is.na(ocean))# gets rid of the points in the French Territory (St. Peirre)

#save the formatted data. 
save(rcp_26,file="data/rcp_26_formatted.RData")
save(rcp_85,file="data/rcp_85_formatted.RData")


#plot it to show how it worked

#oceans coloured
p1 <- ggplot()+
  geom_sf(data=rcp_85,aes(col=ocean))+
  geom_sf(data=Canada)+
  theme_bw()+
  theme(legend.position = c(0.8,0.8))

#bioregions coloured
p2 <- ggplot()+
  geom_sf(data=rcp_26,aes(col=region))+
  geom_sf(data=Canada)+
  theme_bw()+
  theme(legend.position = "none") # too many to show on the quick inspection plot

#marine conservation areas plot
p3 <- ggplot()+
      geom_sf(data=rcp_26%>%filter(!is.na(name)),aes(col=region))+ #the NAs are excluded because they fall outside the network
      geom_sf(data=Canada)+
      theme_bw()+
      theme(legend.position = "none")

#maritimes region plot
mar_bounds <- mar_region%>%st_bbox() # bounding box to limit the plot extent to the size of the bioreigon

p4 <- ggplot()+
      geom_sf(data=rcp_26%>%filter(!is.na(mar_name)),aes(col=mar_name))+
      geom_sf(data=mar_network,fill=NA,col="black")+
      geom_sf(data=mar_region,fill=NA)+
      geom_sf(data=Canada)+
      theme_bw()+
      theme(legend.position = "none")+
      coord_sf(expand=0,xlim=mar_bounds[c(1,3)],ylim=mar_bounds[c(2,4)])
  
#bring these together into one plot to view
p5 <- p1 + p2 + p3 + p4 + plot_layout(ncol=2) ; p5

ggsave("output/points_overlaid.png",p5,width=8, height=8,units="in",dpi=300)
